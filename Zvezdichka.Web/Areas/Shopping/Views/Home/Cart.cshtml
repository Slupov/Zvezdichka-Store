@model IQueryable<Zvezdichka.Web.Areas.Shopping.Models.CartItemListingViewModel>

@{
    ViewBag.Title = "title";
    Layout = "_Layout";
    decimal totalPrice = 0;
}

<h2>My Cart</h2>

<div class="row">
    <div class="col-xs-12">
        <table class="table table-responsive table-striped">
            <tr>
                <th>
                </th>
                <th>
                    Product details
                </th>
                <th>
                    Qty
                </th>
                <th>
                    Price
                </th>
                <th>
                    Total Price
                </th>
            </tr>

            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        <img src="@item.ThumbnailSource" class="img-responsive img-thumbnail" style="max-height: 100px"/>
                    </td>
                    <td>
                        @item.ProductName

                        <div>
                            <a asp-area="Shopping" asp-controller="CartItems" asp-action="Delete" asp-route-name="@item.ProductName"
                               class="btn btn-default col-md-1">
                                <i class="fa fa-trash-o" aria-hidden="true"></i>
                            </a>
                        </div>
                    </td>
                    <td>
                        <div>
                            <input type="number" class="form-control" value="@item.Quantity" id="bag-quantity-@item.Id"/>
                        </div>

                        <div>
                            <a class="btn btn-info" onclick="updateBag(@item.Id)">Update bag</a>
                        </div>
                    </td>
                    <td>
                        @item.Price
                    </td>
                    <td>
                        @(item.Price * item.Quantity)
                    </td>
                </tr>

                totalPrice += item.Price * item.Quantity;
            }

        </table>
    </div>
</div>


<h3>Total: @totalPrice</h3>
<a asp-controller="Home" asp-action="Checkout" asp-route-totalPrice="@totalPrice" class="btn btn-success">Checkout</a>

@section Scripts
{
    <script>
        function updateBag(cartItemId) {
            var newQuantity = $("#bag-quantity-" + cartItemId).val();

            $.ajax(
                    {
                        type: "PUT",
                        traditional: true,
                        url: "/api/cartItems",
                        data: {
                            id: cartItemId,
                            quantity: newQuantity
                        }
                    })
                .done(function() {
                    location.reload();
                })
                .error(function() {
                    alert("Error updating shopping cart");
                });
        }
    </script>

}