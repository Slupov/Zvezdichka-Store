@model IQueryable<Zvezdichka.Web.Areas.Shopping.Models.CartItemListingViewModel>

@{
    ViewBag.Title = "title";
    Layout = "_Layout";
    decimal totalPrice = 0;
}

<h2>My Cart</h2>

<form asp-area="Shopping" asp-controller="Checkout" asp-action="Index" id="checkOutForm" method="get"></form>

<div class="row">
    <div class="col-xs-12">
        <table class="table table-responsive table-striped">
            <tr>
                <th>
                </th>
                <th>
                    Product details
                </th>
                <th>
                    Qty
                </th>
                <th>
                    Price
                </th>
                <th>
                    Total Price
                </th>
            </tr>

            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        <img src="@item.ThumbnailSource" class="img-responsive img-thumbnail" style="max-height: 100px"/>
                    </td>
                    <td>
                        <span class="product-name" name="product-@item.Id">@item.ProductName</span>

                        <div>
                            <a asp-area="Shopping" asp-controller="Home" asp-action="DeleteCart" asp-route-id="@item.Id"class="btn btn-default">
                                <i class="fa fa-trash-o col-md-12" aria-hidden="true"></i>
                            </a>
                        </div>
                    </td>
                    <td class="row">
                        <form asp-area="Shopping" asp-controller="Home" asp-action="UpdateCart" method="post">
                            <div>
                                <input type="number" class="form-control" name="quantity" value="@item.Quantity" id="bag-quantity-@item.Id" class="col-xs-12" />
                            </div>

                            <div>
                                <input type="hidden" name="id" value="@item.Id" />
                                <input type="hidden" name="id" value="@item.Id" form="checkOutForm" />

                                <button type="submit" class="btn btn-info col-xs-12" value="Update bag">Update bag</button>
                            </div>
                        </form>

                    </td>
                    <td>
                        @item.Price
                    </td>
                    <td>
                        @(item.Price * item.Quantity)
                    </td>
                </tr>

                totalPrice += item.Price * item.Quantity;
            }

        </table>
    </div>
</div>


<h3>Total: @totalPrice</h3>
<button type="submit" class="btn btn-success" form="checkOutForm">Checkout</button>

@section Scripts
{
    <script>
        function checkOut() {
            var products = new Array();
            var productNames = $('.product-name').each(function(index) {
                var nameAttr = $(this).attr('name');
                var productId = nameAttr.substr(nameAttr.indexOf('-') + 1);
                var bagQuantity = $("#bag-quantity-" + productId).val();

                var productName = $(this).text();

                products.push({ name: productName, quantity: bagQuantity });
                console.log(index + ": productId=" + productId + " productName=" + productName);
            });

            console.dir(products);

            $.ajax(
                    {
                        type: "POST",
                        traditional: true,
                        url: "/shopping/home/checkout",
                        contentType: "application/json",
                        data: JSON.stringify(products)
                    })
                .done(function() {
//                    location.reload();
                })
                .fail(function() {
                });
        }
    </script>

}